---
phase: 13-folder-mapping
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/templates/types.ts
  - src/templates/validator.ts
  - src/templates/builtin/worldbuilding.ts
  - src/templates/builtin/research.ts
  - src/templates/builtin/people-management.ts
  - src/templates/folder-mapper.ts
  - obsidian-plugin/main.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can configure folder mappings in config.json via template folderMappings field"
    - "Template configurations with invalid folder mappings are rejected at load time"
    - "Builtin templates define default folder mappings for their entity types"
    - "FolderMapper uses template folderMappings when available instead of hardcoded defaults"
  artifacts:
    - path: "src/templates/types.ts"
      provides: "folderMappings field in TemplateDefinition interface"
      contains: "folderMappings?: FolderMappingRule[]"
    - path: "src/templates/validator.ts"
      provides: "Zod schema for folder mapping validation in templates"
      contains: "FolderMappingRuleSchema"
    - path: "src/templates/builtin/worldbuilding.ts"
      provides: "Default folder mappings for worldbuilding entity types"
      contains: "folderMappings:"
    - path: "src/templates/builtin/research.ts"
      provides: "Default folder mappings for research entity types"
      contains: "folderMappings:"
    - path: "src/templates/folder-mapper.ts"
      provides: "createFromTemplate helper method"
      contains: "createFromTemplate"
  key_links:
    - from: "src/templates/types.ts"
      to: "src/templates/builtin/*.ts"
      via: "TemplateDefinition interface"
      pattern: "folderMappings.*FolderMappingRule"
    - from: "src/templates/validator.ts"
      to: "src/templates/types.ts"
      via: "Zod schema matching TypeScript types"
      pattern: "FolderMappingRuleSchema"
    - from: "src/templates/folder-mapper.ts"
      to: "obsidian-plugin/main.ts"
      via: "createFromTemplate method"
      pattern: "FolderMapper\\.createFromTemplate"
---

<objective>
Integrate folder mappings into the config system by adding folderMappings field to TemplateDefinition, populating builtin templates with default mappings, and wiring consumers to read template config.

Purpose: Close the gap where FolderMapper infrastructure exists but is not connected to the config system, preventing users from configuring folder mappings in config.json.

Output:
- Updated TemplateDefinition interface with folderMappings field
- Zod validation schema for folder mappings in template validator
- Builtin templates with sensible default folder mappings
- FolderMapper.createFromTemplate() helper for easy integration
- Obsidian plugin wired to use template folderMappings
</objective>

<execution_context>
@C:\Users\Preston\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Preston\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-folder-mapping/13-VERIFICATION.md
@.planning/phases/13-folder-mapping/13-01-SUMMARY.md

# Source files to modify
@src/templates/types.ts
@src/templates/validator.ts
@src/templates/builtin/worldbuilding.ts
@src/templates/builtin/research.ts
@src/templates/builtin/people-management.ts
@src/templates/folder-mapper.ts
@obsidian-plugin/main.ts

# Reference: registry for active template access
@src/templates/registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add folderMappings to TemplateDefinition and create Zod schema in validator</name>
  <files>src/templates/types.ts, src/templates/validator.ts</files>
  <action>
1. In src/templates/types.ts, add folderMappings field to TemplateDefinition interface:
   ```typescript
   /** Folder-to-type mappings for this template */
   folderMappings?: FolderMappingRule[];
   ```
   Add it after the `minHivemindVersion` field in the Discovery metadata section.

2. In src/templates/validator.ts, add Zod schema for folder mapping validation. Add the following BEFORE TemplateDefinitionSchema:
   ```typescript
   /**
    * Zod schema for folder mapping rule validation.
    */
   export const FolderMappingRuleSchema = z.object({
     folder: z.string().min(1, 'Folder pattern is required'),
     types: z.array(z.string().min(1)).min(1, 'At least one type is required'),
   });
   ```

3. Update TemplateDefinitionSchema in validator.ts to include folderMappings validation:
   Add this field inside the z.object() after minHivemindVersion:
   ```typescript
   folderMappings: z.array(FolderMappingRuleSchema).optional(),
   ```

Note: FolderMappingRule is already defined in types.ts (created in Plan 01). The Zod schema should match that interface structure. The validator.ts file handles template validation (as noted in schema.ts line 24: "Validated separately by template validator").
  </action>
  <verify>
- `npx tsc --noEmit` passes with no type errors
- grep "folderMappings" src/templates/types.ts shows the new field
- grep "FolderMappingRuleSchema" src/templates/validator.ts shows the new schema
  </verify>
  <done>
- TemplateDefinition interface has folderMappings?: FolderMappingRule[] field
- FolderMappingRuleSchema exists in validator.ts
- TemplateDefinitionSchema includes folderMappings validation
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add folder mappings to builtin templates</name>
  <files>src/templates/builtin/worldbuilding.ts, src/templates/builtin/research.ts, src/templates/builtin/people-management.ts</files>
  <action>
1. In worldbuilding.ts, add folderMappings array to worldbuildingTemplate object (after minHivemindVersion or before entityTypes):
   ```typescript
   // Folder-to-type mappings for auto-detection
   folderMappings: [
     // Character mappings
     { folder: '**/Characters/**', types: ['character'] },
     { folder: '**/People/**', types: ['character'] },
     { folder: '**/NPCs/**', types: ['character'] },
     { folder: '**/PCs/**', types: ['character'] },
     { folder: '**/Cast/**', types: ['character'] },
     // Location mappings
     { folder: '**/Locations/**', types: ['location'] },
     { folder: '**/Places/**', types: ['location'] },
     { folder: '**/Geography/**', types: ['location'] },
     { folder: '**/World/**', types: ['location'] },
     { folder: '**/Regions/**', types: ['location'] },
     { folder: '**/Cities/**', types: ['location'] },
     { folder: '**/Towns/**', types: ['location'] },
     // Event mappings
     { folder: '**/Events/**', types: ['event'] },
     { folder: '**/Timeline/**', types: ['event'] },
     { folder: '**/History/**', types: ['event'] },
     { folder: '**/Sessions/**', types: ['event'] },
     // Faction mappings
     { folder: '**/Factions/**', types: ['faction'] },
     { folder: '**/Organizations/**', types: ['faction'] },
     { folder: '**/Groups/**', types: ['faction'] },
     { folder: '**/Guilds/**', types: ['faction'] },
     { folder: '**/Houses/**', types: ['faction'] },
     // Lore mappings
     { folder: '**/Lore/**', types: ['lore'] },
     { folder: '**/Mythology/**', types: ['lore'] },
     { folder: '**/Magic/**', types: ['lore'] },
     { folder: '**/Culture/**', types: ['lore'] },
     { folder: '**/Religion/**', types: ['lore'] },
     // Asset mappings
     { folder: '**/Assets/**', types: ['asset'] },
     { folder: '**/Images/**', types: ['asset'] },
     { folder: '**/Media/**', types: ['asset'] },
     // Reference mappings
     { folder: '**/References/**', types: ['reference'] },
     { folder: '**/Sources/**', types: ['reference'] },
     { folder: '**/Inspiration/**', types: ['reference'] },
     { folder: '**/Notes/**', types: ['reference'] },
     { folder: '**/Meta/**', types: ['reference'] },
   ],
   ```

2. In research.ts, add folderMappings for research entity types:
   ```typescript
   folderMappings: [
     // Paper mappings
     { folder: '**/Papers/**', types: ['paper'] },
     { folder: '**/Literature/**', types: ['paper'] },
     { folder: '**/Articles/**', types: ['paper'] },
     { folder: '**/Publications/**', types: ['paper'] },
     // Concept mappings
     { folder: '**/Concepts/**', types: ['concept'] },
     { folder: '**/Theories/**', types: ['concept'] },
     { folder: '**/Definitions/**', types: ['concept'] },
     // Note mappings
     { folder: '**/Notes/**', types: ['note'] },
     { folder: '**/Ideas/**', types: ['note'] },
     { folder: '**/Observations/**', types: ['note'] },
     // Citation mappings
     { folder: '**/Citations/**', types: ['citation'] },
     { folder: '**/References/**', types: ['citation'] },
   ],
   ```

3. In people-management.ts, add folderMappings for people management entity types:
   ```typescript
   folderMappings: [
     // Person mappings
     { folder: '**/People/**', types: ['person'] },
     { folder: '**/Team/**', types: ['person'] },
     { folder: '**/Staff/**', types: ['person'] },
     { folder: '**/Contacts/**', types: ['person'] },
     // Goal mappings
     { folder: '**/Goals/**', types: ['goal'] },
     { folder: '**/OKRs/**', types: ['goal'] },
     { folder: '**/Objectives/**', types: ['goal'] },
     // Team mappings
     { folder: '**/Teams/**', types: ['team'] },
     { folder: '**/Departments/**', types: ['team'] },
     { folder: '**/Groups/**', types: ['team'] },
     // One-on-one mappings
     { folder: '**/1-on-1/**', types: ['one_on_one'] },
     { folder: '**/One-on-Ones/**', types: ['one_on_one'] },
     { folder: '**/Meetings/**', types: ['one_on_one'] },
   ],
   ```

Note: Use Title Case for folder names in patterns (e.g., "Characters" not "characters") to match typical Obsidian vault conventions. The patterns use glob ** wildcards for flexibility.
  </action>
  <verify>
- `npx tsc --noEmit` passes with no type errors
- grep -c "folderMappings:" src/templates/builtin/*.ts returns 3 (one per template)
- Each template's folderMappings array contains mappings for all its entity types
  </verify>
  <done>
- worldbuilding.ts has folderMappings covering character, location, event, faction, lore, asset, reference
- research.ts has folderMappings covering paper, concept, note, citation
- people-management.ts has folderMappings covering person, goal, team, one_on_one
- All templates compile without type errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add createFromTemplate helper and wire Obsidian plugin</name>
  <files>src/templates/folder-mapper.ts, obsidian-plugin/main.ts</files>
  <action>
1. In src/templates/folder-mapper.ts, add a new static helper method after createWithDefaults():
   ```typescript
   /**
    * Create a FolderMapper from template folderMappings.
    *
    * Converts template-style FolderMappingRule[] to FolderMappingConfig.
    * Falls back to defaults if no mappings provided.
    *
    * @param folderMappings - Array of folder mapping rules from template
    * @param fallbackType - Optional fallback type when no pattern matches
    * @returns Promise resolving to configured FolderMapper
    */
   static async createFromTemplate(
     folderMappings?: FolderMappingRule[],
     fallbackType?: string
   ): Promise<FolderMapper> {
     // If template has mappings, use them
     if (folderMappings && folderMappings.length > 0) {
       return FolderMapper.create({
         mappings: folderMappings,
         fallbackType,
       });
     }
     // Fall back to defaults (worldbuilding patterns)
     return FolderMapper.createWithDefaults();
   }
   ```

2. In obsidian-plugin/main.ts, update the FolderMapper initialization (around line 173).

   First, add import for FolderMappingRule type at the top:
   ```typescript
   import type { ResolveResult, FolderMappingRule } from '../src/templates/types.js';
   ```

   Then update onload() to accept optional folderMappings parameter (for future MCP integration):
   ```typescript
   // Initialize folder mapper with defaults (will be updated when MCP connects)
   this.folderMapper = await FolderMapper.createFromTemplate();
   ```

   This change is minimal but enables future wiring where the plugin can receive
   folderMappings from the MCP server and reinitialize the mapper:
   ```typescript
   // Future: when receiving template config from MCP
   // this.folderMapper = await FolderMapper.createFromTemplate(template.folderMappings);
   ```

Note: The full MCP integration (plugin queries server for active template folderMappings)
is out of scope for this plan. This task just adds the helper method and updates the
plugin to use it, enabling easy future wiring.
  </action>
  <verify>
- `npx tsc --noEmit` passes with no type errors
- grep "createFromTemplate" src/templates/folder-mapper.ts shows the new method
- grep "createFromTemplate" obsidian-plugin/main.ts shows the plugin using it
- `npm test` passes (folder-mapper tests should still work)
  </verify>
  <done>
- FolderMapper.createFromTemplate() method exists and accepts FolderMappingRule[]
- Obsidian plugin uses createFromTemplate() instead of createWithDefaults()
- TypeScript compiles without errors
- All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify integration with existing tests</name>
  <files>N/A (test run only)</files>
  <action>
Run the existing test suite to ensure the changes don't break anything:

1. Run `npm test` to execute all tests
2. Verify folder-mapper tests still pass (44 tests)
3. Verify template validation tests still pass
4. Check for any type errors or regressions

If any tests fail due to the new field:
- Add folderMappings to test fixtures if needed
- Ensure optional field doesn't break existing template loading

The folderMappings field is optional, so existing tests should pass unchanged.
  </action>
  <verify>
- `npm test` passes with all tests green
- No regressions in folder-mapper tests
- No regressions in template validation tests
  </verify>
  <done>
- All existing tests pass
- No regressions introduced by the new folderMappings field
- Integration is complete and verified
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type Check**: `npx tsc --noEmit` passes
2. **Tests Pass**: `npm test` shows all tests passing
3. **Interface Updated**: grep confirms folderMappings in TemplateDefinition
4. **Schema Added**: grep confirms FolderMappingRuleSchema in validator.ts
5. **Templates Updated**: All 3 builtin templates have folderMappings arrays
6. **Wiring Complete**: createFromTemplate method exists and is used by plugin
</verification>

<success_criteria>
1. TemplateDefinition interface includes optional folderMappings field
2. FolderMappingRuleSchema exists in validator.ts and validates template folder mappings
3. All 3 builtin templates (worldbuilding, research, people-management) have sensible default folder mappings
4. FolderMapper.createFromTemplate() helper method exists for easy template integration
5. Obsidian plugin uses createFromTemplate() for FolderMapper initialization
6. TypeScript compilation succeeds
7. All existing tests pass
8. Gap closure: Config path from template.folderMappings to FolderMapper is complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-folder-mapping/13-03-SUMMARY.md`
</output>
