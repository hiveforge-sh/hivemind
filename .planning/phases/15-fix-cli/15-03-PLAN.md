---
phase: 15-fix-cli
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - src/cli/fix/index.ts
  - src/cli.ts
  - tests/cli/fix/fixer.test.ts
  - tests/cli/fix/id-generator.test.ts
  - tests/cli/fix/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "User runs `npx hivemind fix` and sees dry-run preview (no files modified)"
    - "User runs `npx hivemind fix --apply` to modify files"
    - "User is prompted for type when folder mapping is ambiguous"
    - "User can skip prompts with --yes for automation"
    - "User can get JSON output with --json for CI integration"
  artifacts:
    - path: "src/cli/fix/index.ts"
      provides: "CLI entry point with arg parsing and orchestration"
      exports: ["fixCommand"]
    - path: "src/cli.ts"
      provides: "Updated CLI with fix command wired in"
      contains: "fixCommand"
    - path: "tests/cli/fix/fixer.test.ts"
      provides: "Unit tests for FileFixer"
      min_lines: 50
    - path: "tests/cli/fix/id-generator.test.ts"
      provides: "Unit tests for ID generator"
      min_lines: 30
    - path: "tests/cli/fix/integration.test.ts"
      provides: "Integration tests for fix command"
      min_lines: 50
  key_links:
    - from: "src/cli/fix/index.ts"
      to: "src/cli/fix/fixer.ts"
      via: "FileFixer instantiation"
      pattern: "new FileFixer"
    - from: "src/cli/fix/index.ts"
      to: "@inquirer/prompts"
      via: "select prompt for ambiguous types"
      pattern: "import.*select.*@inquirer/prompts"
    - from: "src/cli.ts"
      to: "src/cli/fix/index.ts"
      via: "fixCommand import and routing"
      pattern: "import.*fixCommand"
---

<objective>
Wire fix command into CLI with prompts and tests

Purpose: Complete the fix command by adding CLI entry point with argument parsing, interactive prompts for ambiguous types, and comprehensive test coverage

Output: Working `npx hivemind fix` command with dry-run default, --apply flag, --yes for automation, --json for CI, plus unit and integration tests
</objective>

<execution_context>
@C:\Users\Preston\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Preston\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-fix-cli/15-CONTEXT.md
@.planning/phases/15-fix-cli/15-RESEARCH.md

# CLI entry point patterns
@src/cli.ts
@src/cli/validate/index.ts
@src/cli/init/wizard.ts

# Modules from 15-01 and 15-02 (will exist after those plans complete)
# src/cli/fix/types.ts
# src/cli/fix/fixer.ts
# src/cli/fix/id-generator.ts
# src/cli/fix/writer.ts
# src/cli/fix/formatter.ts

# Test patterns from validate
@tests/cli/validate/scanner.test.ts
@tests/cli/validate/integration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI entry point with prompts</name>
  <files>src/cli/fix/index.ts</files>
  <action>
Create CLI entry point following validate/index.ts and init/wizard.ts patterns:

```typescript
import { existsSync, readFileSync } from 'fs';
import { resolve, dirname } from 'path';
import { select } from '@inquirer/prompts';
import { FileFixer } from './fixer.js';
import { applyOperations } from './writer.js';
import { formatDryRunOutput, formatApplyOutput, formatJsonOutput } from './formatter.js';
import type { FixOptions, FileOperation, FixResult } from './types.js';
import { error } from '../shared/colors.js';

/**
 * Parse command line arguments for fix command.
 */
export function parseFixArgs(): FixOptions

/**
 * Main fix command entry point.
 */
export async function fixCommand(): Promise<void>
```

**Argument parsing (parseFixArgs):**
- `--apply`: Set apply=true (default false = dry-run)
- `--yes` or `-y`: Set yes=true (skip prompts)
- `--json`: Set json=true (machine output)
- `--verbose` or `-v`: Set verbose=true (show file list)
- `--type <type>`: Override folder mapping
- `--ignore <pattern>`: Add to ignorePatterns array
- `--vault <path>`: Override vault path
- First non-flag arg: Target path within vault

**fixCommand() flow:**
1. Parse args with parseFixArgs()
2. TTY check: if !process.stdin.isTTY && !options.yes && !options.json:
   - Print error: "Interactive mode requires a terminal. Use --yes to skip prompts."
   - Exit with code 2
3. Load config.json, get vault path and active template
4. Initialize FileFixer with options
5. Call fixer.analyze() to get operations
6. Handle ambiguous types:
   - If options.yes: skip files with ambiguous types, add to skippedFiles
   - If interactive: batch prompt by folder using select() from @inquirer/prompts
   - Per CONTEXT.md: "Batch prompts by folder (ask once per ambiguous folder)"
7. If options.apply: call applyOperations() and show completion summary
8. If dry-run: show formatDryRunOutput()
9. If options.json: output only formatJsonOutput() to stdout
10. Exit codes: 0 success, 1 failures, 2 config error

**Ambiguous type prompting (per CONTEXT.md):**
```typescript
// Group by folder
const byFolder = new Map<string, FileOperation[]>();
for (const op of ambiguousOps) {
  const folder = dirname(op.path);
  if (!byFolder.has(folder)) byFolder.set(folder, []);
  byFolder.get(folder)!.push(op);
}

// Prompt once per folder
for (const [folder, ops] of byFolder) {
  const type = await select({
    message: `${ops.length} files in ${folder}/ - choose type:`,
    choices: suggestedTypes.map(t => ({ name: t, value: t }))
  });
  // Apply type to all ops in folder
}
```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>CLI entry point handles all flags, TTY check, and folder-batched prompts</done>
</task>

<task type="auto">
  <name>Task 2: Wire fix command into main CLI</name>
  <files>src/cli.ts</files>
  <action>
Update src/cli.ts to:

1. Add import at top:
```typescript
import { fixCommand } from './cli/fix/index.js';
```

2. Replace the existing fix() function (lines ~60-164) with the new fixCommand import

3. Update the switch statement (around line 1189) to call fixCommand():
```typescript
case 'fix':
  fixCommand();
  break;
```

4. Update help text (around line 1219) to show new fix flags:
```typescript
console.log('  npx @hiveforge/hivemind-mcp fix [path]              - Add frontmatter to files (dry-run)');
console.log('    --apply          Apply changes (default: dry-run)');
console.log('    --yes            Skip prompts, use defaults');
console.log('    --json           Output machine-readable JSON');
console.log('    --verbose        Show all files in dry-run');
console.log('    --type <type>    Override folder mapping');
console.log('    --ignore <glob>  Exclude files matching pattern');
```

The existing fix() function can be deleted - it uses the old skipped-files.log approach which is replaced by the new validation-based approach.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Fix command wired into CLI with updated help text</done>
</task>

<task type="auto">
  <name>Task 3: Create unit and integration tests</name>
  <files>
    tests/cli/fix/fixer.test.ts
    tests/cli/fix/id-generator.test.ts
    tests/cli/fix/integration.test.ts
  </files>
  <action>
Create test files following validate test patterns (temp directories, fixtures).

**tests/cli/fix/id-generator.test.ts:**
```typescript
import { describe, it, expect } from 'vitest';
import { slugifyFilename, generateUniqueId } from '../../../src/cli/fix/id-generator.js';

describe('slugifyFilename', () => {
  it('converts spaces to hyphens');
  it('removes special characters');
  it('lowercases the result');
  it('removes leading/trailing hyphens');
  it('handles already-slugified names');
});

describe('generateUniqueId', () => {
  it('returns base ID when no collision');
  it('adds type prefix on first collision');
  it('adds counter on subsequent collisions');
  it('adds generated ID to existingIds set');
});
```

**tests/cli/fix/fixer.test.ts:**
```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { mkdtempSync, writeFileSync, rmSync, mkdirSync } from 'fs';
import { join } from 'path';
import { tmpdir } from 'os';
import { FileFixer } from '../../../src/cli/fix/fixer.js';

describe('FileFixer', () => {
  let tempDir: string;

  beforeEach(() => {
    tempDir = mkdtempSync(join(tmpdir(), 'hivemind-test-'));
  });

  afterEach(() => {
    rmSync(tempDir, { recursive: true, force: true });
  });

  it('identifies files with missing frontmatter');
  it('generates frontmatter with required fields');
  it('preserves existing frontmatter values');
  it('only adds missing required fields to partial frontmatter');
  it('resolves entity type from folder mapping');
});
```

**tests/cli/fix/integration.test.ts:**
```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { mkdtempSync, writeFileSync, readFileSync, rmSync, mkdirSync } from 'fs';
import { join } from 'path';
import { tmpdir } from 'os';
import { execSync } from 'child_process';

describe('fix command integration', () => {
  let tempDir: string;

  beforeEach(() => {
    tempDir = mkdtempSync(join(tmpdir(), 'hivemind-fix-test-'));
    // Create config.json
    // Create Characters/ folder with test files
  });

  afterEach(() => {
    rmSync(tempDir, { recursive: true, force: true });
  });

  it('shows dry-run preview by default (no file modifications)');
  it('requires --apply to modify files');
  it('skips ambiguous folders in --yes mode with warning');
  it('outputs valid JSON with --json flag');
  it('exits 0 on success');
  it('exits 1 when files fail to write');
});
```

Follow Phase 14 test patterns:
- Use mkdtempSync for temp directories
- Clean up in afterEach
- Create realistic fixtures (config.json, markdown files)
- Use valid status enum values (canon, draft, not 'approved')
  </action>
  <verify>npm test -- --run tests/cli/fix/</verify>
  <done>Tests cover ID generation, FileFixer logic, and CLI integration</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. `npm test -- --run tests/cli/fix/` passes
4. Manual test: `npx . fix --vault ./samples/worldbuilding` shows dry-run preview
5. Manual test: `npx . fix --vault ./samples/worldbuilding --json` outputs valid JSON
</verification>

<success_criteria>
- FIX-01: fix command shows dry-run preview by default
- FIX-02: --apply flag required to modify files
- FIX-03: Uses folder-to-type mapping from config
- FIX-04: Prompts for type when ambiguous (batched by folder)
- FIX-05: --yes skips prompts for automation
- FIX-06: --json outputs machine-parseable results
</success_criteria>

<output>
After completion, create `.planning/phases/15-fix-cli/15-03-SUMMARY.md`
</output>
