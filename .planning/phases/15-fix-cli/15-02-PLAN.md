---
phase: 15-fix-cli
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/fix/writer.ts
  - src/cli/fix/formatter.ts
autonomous: true

must_haves:
  truths:
    - "Writer performs atomic file modifications using temp file + rename pattern"
    - "Formatter shows dry-run preview with field names only (not full values)"
    - "Formatter shows completion summary with counts by type"
  artifacts:
    - path: "src/cli/fix/writer.ts"
      provides: "Safe atomic file writing"
      exports: ["FileWriter", "writeFile"]
    - path: "src/cli/fix/formatter.ts"
      provides: "Dry-run preview and completion summary formatting"
      exports: ["formatDryRunOutput", "formatApplyOutput", "formatJsonOutput"]
  key_links:
    - from: "src/cli/fix/writer.ts"
      to: "gray-matter"
      via: "stringify for frontmatter injection"
      pattern: "matter\\.stringify"
    - from: "src/cli/fix/formatter.ts"
      to: "src/cli/shared/colors.ts"
      via: "picocolors for terminal styling"
      pattern: "import.*colors"
---

<objective>
Create file writer and output formatter for fix command

Purpose: Enable safe atomic file writes and provide clear user feedback for both dry-run preview and apply operations

Output: Writer module with atomic temp-file-then-rename pattern, formatter module for dry-run preview and completion summary
</objective>

<execution_context>
@C:\Users\Preston\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Preston\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-fix-cli/15-CONTEXT.md
@.planning/phases/15-fix-cli/15-RESEARCH.md

# Validate formatter patterns to follow
@src/cli/validate/formatter.ts

# Shared colors module
@src/cli/shared/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create atomic file writer</name>
  <files>src/cli/fix/writer.ts</files>
  <action>
Create writer module following RESEARCH.md atomic write pattern:

```typescript
import { promises as fs } from 'fs';
import { join, dirname } from 'path';
import { tmpdir } from 'os';
import matter from 'gray-matter';
import type { FileOperation } from './types.js';

/**
 * Result of a single file write operation.
 */
export interface WriteResult {
  path: string;
  success: boolean;
  error?: string;
}

/**
 * Write frontmatter to a file atomically.
 *
 * Uses temp file + rename pattern:
 * 1. Read existing file content
 * 2. Parse/update frontmatter with gray-matter
 * 3. Write to temp file
 * 4. Rename temp to target (atomic)
 * 5. Cleanup temp on failure
 */
export async function writeFile(
  vaultPath: string,
  operation: FileOperation
): Promise<WriteResult>

/**
 * Apply multiple fix operations to files.
 *
 * @param vaultPath - Absolute path to vault root
 * @param operations - File operations from FileFixer.analyze()
 * @returns Array of write results
 */
export async function applyOperations(
  vaultPath: string,
  operations: FileOperation[]
): Promise<WriteResult[]>
```

Implementation details for `writeFile()`:
1. Build absolute path: `join(vaultPath, operation.path)`
2. Read existing content
3. Parse with gray-matter: `const file = matter(content)`
4. Merge frontmatter: `{ ...file.data, ...operation.frontmatter }`
5. Stringify: `matter.stringify(file.content, mergedData)`
6. Generate temp path: `join(tmpdir(), \`hivemind-${Date.now()}-${Math.random().toString(36).slice(2)}.md\`)`
7. Write to temp: `await fs.writeFile(tempPath, output, 'utf-8')`
8. Rename to target: `await fs.rename(tempPath, targetPath)`
9. On error: cleanup temp file with `await fs.unlink(tempPath).catch(() => {})`

`applyOperations()` loops through operations, collecting results. Continue on individual file failures (don't abort batch).
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Writer performs atomic file operations with proper error handling</done>
</task>

<task type="auto">
  <name>Task 2: Create output formatter</name>
  <files>src/cli/fix/formatter.ts</files>
  <action>
Create formatter following validate/formatter.ts patterns and CONTEXT.md decisions:

```typescript
import { dim, cyan, green, yellow, red, bold } from '../shared/colors.js';
import type { FileOperation, FixResult, FixSummary } from './types.js';
import type { WriteResult } from './writer.js';

/**
 * Format dry-run preview output.
 * Shows field names only (not values) per CONTEXT.md.
 */
export function formatDryRunOutput(
  operations: FileOperation[],
  verbose: boolean
): string

/**
 * Format completion summary after --apply.
 */
export function formatApplyOutput(
  summary: FixSummary,
  writeResults: WriteResult[]
): string

/**
 * Format JSON output for CI integration.
 */
export function formatJsonOutput(result: FixResult): string
```

**Dry-run output format (per CONTEXT.md):**
```
Dry-run preview (no files modified):

character: 5 files
  Characters/John.md
    + id, type, status, tags, name

location: 3 files
  Locations/Castle.md
    + id, type, status

Run `hivemind fix --apply` to apply changes
```

With `--verbose`: show all files. Without: show summary counts only.

**Apply output format:**
```
Fixed 23 files. 2 files could not be fixed:
  - Locations/locked.md: Permission denied
  - Events/broken.md: Parse error
```

**JSON output format:**
```json
{
  "success": true,
  "applied": true,
  "summary": {
    "totalFiles": 25,
    "fixedFiles": 23,
    "skippedFiles": 0,
    "failedFiles": 2,
    "byType": {"character": 15, "location": 8}
  },
  "files": [
    {"path": "Characters/John.md", "type": "character", "fieldsAdded": ["id", "type", "status"]}
  ],
  "failures": [
    {"path": "Locations/locked.md", "error": "Permission denied"}
  ]
}
```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Formatter produces dry-run preview, apply summary, and JSON output</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Writer imports gray-matter correctly
4. Formatter imports shared colors correctly
5. Both modules export their public functions
</verification>

<success_criteria>
- Writer uses atomic temp-file-then-rename pattern
- Writer continues batch on individual failures (doesn't abort)
- Formatter dry-run shows field names only (per CONTEXT.md)
- Formatter apply shows counts + failure list
- JSON output is valid JSON with summary and file details
</success_criteria>

<output>
After completion, create `.planning/phases/15-fix-cli/15-02-SUMMARY.md`
</output>
