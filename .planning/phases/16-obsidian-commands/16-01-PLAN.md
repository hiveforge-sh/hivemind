---
phase: 16-obsidian-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - obsidian-plugin/main.ts
autonomous: true

must_haves:
  truths:
    - "User runs 'Hivemind: Add frontmatter' from command palette and sees preview modal showing what will be added"
    - "User sees type selection modal when folder mapping is ambiguous"
    - "User confirms preview and frontmatter is inserted/merged into active file"
  artifacts:
    - path: "obsidian-plugin/main.ts"
      provides: "Add frontmatter command with AddFrontmatterModal and preview flow"
      contains: "add-frontmatter"
  key_links:
    - from: "AddFrontmatterModal"
      to: "FolderMapper.resolveType"
      via: "type resolution from file path"
      pattern: "folderMapper.*resolveType"
    - from: "AddFrontmatterModal"
      to: "insertMissingFrontmatter"
      via: "apply confirmed frontmatter"
      pattern: "insertMissingFrontmatter"
---

<objective>
Add the "Hivemind: Add frontmatter" command to the Obsidian plugin with a preview modal that shows what will be added before applying.

Purpose: Users can add frontmatter to any note from the command palette with full preview and type auto-detection.
Output: Working "Add frontmatter" command with preview modal, type selection for ambiguous folders, and merge logic for existing frontmatter.
</objective>

<execution_context>
@C:\Users\Preston\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Preston\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@obsidian-plugin/main.ts
@.planning/phases/16-obsidian-commands/16-CONTEXT.md
@.planning/phases/16-obsidian-commands/16-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register "Hivemind: Add frontmatter" command and create AddFrontmatterModal</name>
  <files>obsidian-plugin/main.ts</files>
  <action>
1. Add a new command in the `onload()` method:
   ```typescript
   this.addCommand({
     id: 'add-frontmatter',
     name: 'Add frontmatter',
     editorCallback: (editor: Editor, view: MarkdownView) => {
       if (view.file) {
         this.addFrontmatterToFile(view.file);
       }
     }
   });
   ```

2. Create `addFrontmatterToFile(file: TFile)` method on HivemindPlugin:
   - Read file content via `this.app.vault.read(file)`
   - Check existing frontmatter via `this.app.metadataCache.getFileCache(file)`
   - Use `this.folderMapper.resolveType(file.path)` to determine entity type
   - If confidence === 'exact': open AddFrontmatterModal with that type
   - If confidence === 'ambiguous': open TypeSelectionModal (already exists) but modify callback to open AddFrontmatterModal after selection
   - If confidence === 'none': open TypeSelectionModal with no suggestions, callback opens AddFrontmatterModal

3. Create `AddFrontmatterModal extends Modal`:
   - Constructor: `(app, plugin, file, entityType, existingFrontmatter)`
   - `onOpen()`:
     - Show heading: "Add Frontmatter"
     - Show file name
     - Show detected/selected type with badge
     - Build template frontmatter from FRONTMATTER_TEMPLATES[entityType]
     - Auto-fill id (using generateId pattern), name/title from filename
     - Compute fields to add: template fields NOT in existing frontmatter
     - If no fields to add: show "All fields present" message + close button
     - Display preview section: list each field name and its default value in a styled list
     - Show "Apply" (mod-cta) and "Cancel" buttons
   - On "Apply": call `this.plugin.insertMissingFrontmatter(file, existingFrontmatter, newFields)` then close
   - `onClose()`: empty contentEl

4. Modify the existing TypeSelectionModal to accept an optional callback `onTypeSelected?: (type: string) => void`:
   - If callback provided, call it instead of directly applying type
   - This allows reuse: add-frontmatter flow passes callback that opens AddFrontmatterModal
   - Keep existing behavior (direct apply) as default when no callback

5. Remove or rename the old 'check-missing-frontmatter' command to avoid confusion. The new 'add-frontmatter' command replaces it with better UX (preview modal).
  </action>
  <verify>
Build the plugin: `cd obsidian-plugin && npm run build`. No TypeScript errors. The command 'add-frontmatter' appears in the built output.
  </verify>
  <done>
"Hivemind: Add frontmatter" command registered. AddFrontmatterModal shows preview of fields to add. TypeSelectionModal accepts optional callback for reuse. Old check-missing-frontmatter command removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add right-click context menu for "Add frontmatter"</name>
  <files>obsidian-plugin/main.ts</files>
  <action>
1. In `onload()`, register file menu event:
   ```typescript
   this.registerEvent(
     this.app.workspace.on('file-menu', (menu, file) => {
       if (file instanceof TFile && file.extension === 'md') {
         menu.addItem((item) => {
           item.setTitle('Hivemind: Add frontmatter')
             .setIcon('plus-circle')
             .onClick(() => {
               this.addFrontmatterToFile(file);
             });
         });
       }
     })
   );
   ```

2. Also register folder context menu for bulk add:
   ```typescript
   this.registerEvent(
     this.app.workspace.on('file-menu', (menu, file) => {
       if (file instanceof TFolder) {
         menu.addItem((item) => {
           item.setTitle('Hivemind: Add frontmatter to folder')
             .setIcon('folder-plus')
             .onClick(() => {
               this.addFrontmatterToFolder(file);
             });
         });
       }
     })
   );
   ```
   Note: Combine both into a single event handler that checks instanceof.

3. Import `TFolder` from 'obsidian' at the top of the file.

4. Create `addFrontmatterToFolder(folder: TFolder)` method:
   - Get all markdown files in folder: `this.app.vault.getMarkdownFiles().filter(f => f.path.startsWith(folder.path))`
   - For each file, resolve type via folderMapper
   - If all resolve to same type: apply to all, show Notice with count
   - If ambiguous: show Notice asking user to use per-file command
   - Show progress Notice: "Adding frontmatter to N files..."
   - Show completion Notice: "Added frontmatter to N files"
  </action>
  <verify>
Build the plugin: `cd obsidian-plugin && npm run build`. No TypeScript errors. TFolder import present.
  </verify>
  <done>
Right-click context menu shows "Add frontmatter" on markdown files and "Add frontmatter to folder" on folders. Bulk folder operation applies frontmatter to all files with clear type.
  </done>
</task>

</tasks>

<verification>
1. `cd obsidian-plugin && npm run build` succeeds with no errors
2. Built output contains 'add-frontmatter' command ID
3. AddFrontmatterModal class exists with preview UI
4. TypeSelectionModal accepts optional callback parameter
5. Context menu registration uses registerEvent pattern
</verification>

<success_criteria>
- "Hivemind: Add frontmatter" command registered and shows preview modal
- Type auto-detection from folder mapping works (exact, ambiguous, none cases)
- Preview modal shows fields that will be added with default values
- Right-click context menu on files and folders works
- Plugin builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-obsidian-commands/16-01-SUMMARY.md`
</output>
