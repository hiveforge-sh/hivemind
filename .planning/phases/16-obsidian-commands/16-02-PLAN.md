---
phase: 16-obsidian-commands
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - obsidian-plugin/main.ts
autonomous: true

must_haves:
  truths:
    - "User runs 'Hivemind: Validate' on a valid file and sees brief toast notification"
    - "User runs 'Hivemind: Validate' on an invalid file and sees modal listing specific issues"
    - "User runs 'Hivemind: Fix' and sees modal with editable default values for missing fields"
    - "User edits values in fix modal and applies changes to file"
  artifacts:
    - path: "obsidian-plugin/main.ts"
      provides: "Validate and Fix commands with ValidationResultModal and FixFieldsModal"
      contains: "validate-frontmatter"
  key_links:
    - from: "validate-frontmatter command"
      to: "ValidationResultModal"
      via: "shows validation issues"
      pattern: "ValidationResultModal"
    - from: "fix-frontmatter command"
      to: "FixFieldsModal"
      via: "shows editable fields"
      pattern: "FixFieldsModal"
    - from: "FixFieldsModal"
      to: "insertMissingFrontmatter"
      via: "applies user-edited values"
      pattern: "insertMissingFrontmatter"
---

<objective>
Add "Hivemind: Validate" and "Hivemind: Fix" commands to the Obsidian plugin with appropriate modal UIs.

Purpose: Users can validate and fix frontmatter from within Obsidian with native UI feedback.
Output: Working validate command (toast for valid, modal for issues) and fix command (editable fields modal).
</objective>

<execution_context>
@C:\Users\Preston\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Preston\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@obsidian-plugin/main.ts
@.planning/phases/16-obsidian-commands/16-CONTEXT.md
@.planning/phases/16-obsidian-commands/16-RESEARCH.md
@.planning/phases/16-obsidian-commands/16-01-SUMMARY.md
@src/cli/validate/types.ts
@src/cli/validate/validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Hivemind: Validate" command with feedback UI</name>
  <files>obsidian-plugin/main.ts</files>
  <action>
1. Register validate command in `onload()`:
   ```typescript
   this.addCommand({
     id: 'validate-frontmatter',
     name: 'Validate frontmatter',
     editorCallback: (editor: Editor, view: MarkdownView) => {
       if (view.file) {
         this.validateCurrentFile(view.file);
       }
     }
   });
   ```

2. Create `validateCurrentFile(file: TFile)` method on HivemindPlugin:
   - Read file content via `this.app.vault.read(file)`
   - Parse frontmatter using gray-matter (import at top: `import matter from 'gray-matter'`)
   - Note: gray-matter is already a dependency of the main project. Check obsidian-plugin/package.json — if not listed, add it as dependency.
   - Perform validation inline (replicating validator.ts logic but using Vault API instead of fs):
     a. Check if frontmatter exists and has content
     b. Check required fields: id, type, status
     c. Check type against template entity types (from templateRegistry.getActive())
     d. Check folder mismatch via folderMapper
   - Do NOT import from `../src/cli/validate/validator.ts` — that module uses Node fs. Implement validation logic directly using Obsidian APIs.
   - If valid: show `new Notice('Valid frontmatter ✓', 3000)` (brief toast)
   - If invalid: open `new ValidationResultModal(this.app, file, issues)`

3. Create `ValidationResultModal extends Modal`:
   - Constructor: `(app, file, issues: Array<{type: string, detail: string}>)`
   - Use simplified issue type: `{type: string, detail: string}` instead of importing CLI types
   - `onOpen()`:
     - Heading: "Validation Issues"
     - Subheading: file name
     - For each issue, create a styled item:
       - 'missing_frontmatter': "No frontmatter found"
       - 'missing_field': "Missing required field: {field}"
       - 'invalid_type': "Invalid type '{actual}'. Valid: {validTypes}"
       - 'schema_error': "Schema error in {field}: {message}"
       - 'folder_mismatch': "Type '{actual}' doesn't match folder (expected '{expected}')"
     - Each issue as a div with icon (warning) + text
     - "Close" button
   - `onClose()`: empty contentEl

4. Add right-click context menu for validate (in existing file-menu handler from Plan 01):
   ```typescript
   // Inside the file-menu handler for TFile
   menu.addItem((item) => {
     item.setTitle('Hivemind: Validate')
       .setIcon('check-circle')
       .onClick(() => {
         this.validateCurrentFile(file);
       });
   });
   ```
  </action>
  <verify>
Build: `cd obsidian-plugin && npm run build`. No TypeScript errors. 'validate-frontmatter' command ID in output.
  </verify>
  <done>
"Hivemind: Validate" shows toast for valid files and modal with issue details for invalid files. Context menu entry added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Hivemind: Fix" command with editable fields modal</name>
  <files>obsidian-plugin/main.ts</files>
  <action>
1. Register fix command in `onload()`:
   ```typescript
   this.addCommand({
     id: 'fix-frontmatter',
     name: 'Fix frontmatter',
     editorCallback: (editor: Editor, view: MarkdownView) => {
       if (view.file) {
         this.fixCurrentFile(view.file);
       }
     }
   });
   ```

2. Create `fixCurrentFile(file: TFile)` method on HivemindPlugin:
   - Read file, parse frontmatter, resolve type (same flow as add-frontmatter)
   - If no frontmatter: redirect to add-frontmatter flow
   - If has frontmatter with type: find missing fields using existing `findMissingFields()` method
   - If no missing fields: show `new Notice('No issues to fix ✓', 3000)`
   - If missing fields found: open `new FixFieldsModal(this.app, this, file, existingFrontmatter, missingFields, entityType)`

3. Create `FixFieldsModal extends Modal`:
   - Constructor: `(app, plugin, file, existingFrontmatter, missingFields, entityType)`
   - `onOpen()`:
     - Heading: "Fix Frontmatter"
     - Subheading: file name + entity type badge
     - For each missing field, create an editable Setting row:
       ```typescript
       new Setting(contentEl)
         .setName(fieldName)
         .setDesc(`Default: ${JSON.stringify(defaultValue)}`)
         .addText(text => text
           .setValue(this.getDefaultDisplay(fieldName, defaultValue))
           .onChange(value => {
             this.editedValues[fieldName] = value;
           })
         );
       ```
     - For array fields, show as comma-separated text input
     - For object fields (like appearance, personality), show as collapsed section with sub-fields
     - Auto-generate ID field value using generateId pattern (editable)
     - "Apply All" button (mod-cta): applies all edited values
     - "Cancel" button
   - Store edited values in `private editedValues: Record<string, any> = {}`
   - On "Apply All": convert editedValues back to proper types (arrays from comma-separated, etc.), call `plugin.insertMissingFrontmatter()`
   - `onClose()`: empty contentEl

4. Add right-click context menu for fix (in existing file-menu handler):
   ```typescript
   menu.addItem((item) => {
     item.setTitle('Hivemind: Fix frontmatter')
       .setIcon('wrench')
       .onClick(() => {
         this.fixCurrentFile(file);
       });
   });
   ```

5. Register "Fix all" bulk command:
   ```typescript
   this.addCommand({
     id: 'fix-all-frontmatter',
     name: 'Fix all frontmatter',
     callback: () => {
       this.fixAllFiles();
     }
   });
   ```

6. Create `fixAllFiles()` method:
   - Get all markdown files in vault
   - For each file: resolve type, find missing fields, auto-apply defaults
   - Show progress Notice during operation
   - Show completion Notice with count: "Fixed N files"
   - Skip files where type is ambiguous (show count of skipped)
  </action>
  <verify>
Build: `cd obsidian-plugin && npm run build`. No TypeScript errors. 'fix-frontmatter' and 'fix-all-frontmatter' command IDs in output.
  </verify>
  <done>
"Hivemind: Fix" shows editable fields modal with defaults. "Hivemind: Fix all" bulk applies fixes. Context menu entries added. Users can edit auto-generated values before applying.
  </done>
</task>

</tasks>

<verification>
1. `cd obsidian-plugin && npm run build` succeeds
2. validate-frontmatter and fix-frontmatter commands registered
3. ValidationResultModal shows detailed issues
4. FixFieldsModal has editable Setting rows for each missing field
5. Fix all command processes vault files with progress feedback
</verification>

<success_criteria>
- Validate shows toast for valid, modal for invalid with specific issue descriptions
- Fix shows editable modal with auto-generated defaults user can modify
- Fix all bulk-applies to entire vault with skip for ambiguous types
- All context menu entries present for validate and fix
- Plugin builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-obsidian-commands/16-02-SUMMARY.md`
</output>
