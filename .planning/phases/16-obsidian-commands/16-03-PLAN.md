---
phase: 16-obsidian-commands
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - obsidian-plugin/main.ts
autonomous: true

must_haves:
  truths:
    - "User can open a sidebar panel showing vault-wide validation results"
    - "User clicks a file in the sidebar panel and navigates to that file"
    - "Settings tab has toggleable behaviors for frontmatter commands"
  artifacts:
    - path: "obsidian-plugin/main.ts"
      provides: "ValidationSidebarView, enhanced settings tab, folder context menus"
      contains: "validation-sidebar"
  key_links:
    - from: "ValidationSidebarView"
      to: "validateCurrentFile logic"
      via: "reuses validation logic for each file"
      pattern: "validateFile.*vault"
    - from: "Settings tab"
      to: "HivemindSettings"
      via: "toggles control command behavior"
      pattern: "settings.*autoMerge|defaultType"
---

<objective>
Add vault-wide validation sidebar panel, enhanced settings tab, and folder-level context menu operations.

Purpose: Users get persistent validation overview of their vault and can configure Hivemind behavior through settings.
Output: Working sidebar panel with clickable results, settings tab with behavior toggles, folder context menus for bulk operations.
</objective>

<execution_context>
@C:\Users\Preston\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Preston\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@obsidian-plugin/main.ts
@.planning/phases/16-obsidian-commands/16-CONTEXT.md
@.planning/phases/16-obsidian-commands/16-RESEARCH.md
@.planning/phases/16-obsidian-commands/16-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ValidationSidebarView for vault-wide validation</name>
  <files>obsidian-plugin/main.ts</files>
  <action>
1. Import `ItemView, WorkspaceLeaf` from 'obsidian' (add to existing import).

2. Create `ValidationSidebarView extends ItemView`:
   - `VIEW_TYPE = 'hivemind-validation-sidebar'`
   - `getViewType()`: return VIEW_TYPE
   - `getDisplayText()`: return 'Hivemind Validation'
   - `getIcon()`: return 'check-circle'
   - Store `plugin: HivemindPlugin` reference
   - `async onOpen()`:
     - Create header with "Validation Results" title
     - Add "Refresh" button that re-runs validation
     - Add "Fix All" button that calls `plugin.fixAllFiles()`
     - Call `this.runValidation()`
   - `async runValidation()`:
     - Clear results container
     - Show "Scanning..." text
     - Get all markdown files: `this.app.vault.getMarkdownFiles()`
     - For each file, run inline validation (same logic as validateCurrentFile but return results)
     - Group results by status: valid files count, invalid files list
     - Show summary: "N valid, M issues found"
     - For each invalid file, create a clickable div:
       ```typescript
       const fileItem = resultsEl.createDiv({ cls: 'tree-item' });
       const fileLink = fileItem.createDiv({ cls: 'tree-item-self is-clickable' });
       fileLink.createSpan({ text: result.path, cls: 'tree-item-inner' });
       fileLink.createSpan({ text: `${result.issues.length} issues`, cls: 'tree-item-flair' });
       fileLink.addEventListener('click', () => {
         const file = this.app.vault.getAbstractFileByPath(result.path);
         if (file instanceof TFile) {
           this.app.workspace.openFile(file);
         }
       });
       ```
     - Show issue details inline under each file (collapsible)
   - `onClose()`: cleanup

3. Register the view in `onload()`:
   ```typescript
   this.registerView(
     'hivemind-validation-sidebar',
     (leaf) => new ValidationSidebarView(leaf, this)
   );
   ```

4. Add command to open sidebar:
   ```typescript
   this.addCommand({
     id: 'open-validation-sidebar',
     name: 'Open validation panel',
     callback: () => {
       this.activateValidationSidebar();
     }
   });
   ```

5. Create `activateValidationSidebar()` method:
   ```typescript
   async activateValidationSidebar() {
     const existing = this.app.workspace.getLeavesOfType('hivemind-validation-sidebar');
     if (existing.length) {
       this.app.workspace.revealLeaf(existing[0]);
       return;
     }
     const leaf = this.app.workspace.getRightLeaf(false);
     if (leaf) {
       await leaf.setViewState({
         type: 'hivemind-validation-sidebar',
         active: true,
       });
       this.app.workspace.revealLeaf(leaf);
     }
   }
   ```

6. Add folder context menu for "Validate folder" and "Fix all in folder":
   In the existing file-menu handler (from Plan 01), add for TFolder:
   ```typescript
   if (file instanceof TFolder) {
     menu.addItem((item) => {
       item.setTitle('Hivemind: Validate folder')
         .setIcon('check-circle')
         .onClick(() => { this.validateFolder(file); });
     });
     menu.addItem((item) => {
       item.setTitle('Hivemind: Fix all in folder')
         .setIcon('wrench')
         .onClick(() => { this.fixFolder(file); });
     });
   }
   ```

7. Create `validateFolder(folder: TFolder)` and `fixFolder(folder: TFolder)` methods:
   - validateFolder: validate all .md files in folder, show Notice summary ("N valid, M issues")
   - fixFolder: similar to fixAllFiles but scoped to folder path
  </action>
  <verify>
Build: `cd obsidian-plugin && npm run build`. No TypeScript errors. ValidationSidebarView class exists. 'open-validation-sidebar' command registered.
  </verify>
  <done>
Sidebar panel shows vault-wide validation with clickable file navigation. Refresh and Fix All buttons work. Folder context menus for validate and fix.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance settings tab with Hivemind frontmatter options</name>
  <files>obsidian-plugin/main.ts</files>
  <action>
1. Extend `HivemindSettings` interface with new fields:
   ```typescript
   interface HivemindSettings {
     // ... existing fields
     defaultEntityType: string;       // Default type when folder mapping fails ('' = always prompt)
     autoMergeFrontmatter: boolean;   // Auto-merge missing fields without preview
     validationSeverity: 'error' | 'warning'; // Treat folder mismatches as error or warning
     showValidationNotices: boolean;  // Show notices on file open if invalid
   }
   ```

2. Update DEFAULT_SETTINGS:
   ```typescript
   const DEFAULT_SETTINGS: HivemindSettings = {
     // ... existing
     defaultEntityType: '',
     autoMergeFrontmatter: false,
     validationSeverity: 'warning',
     showValidationNotices: false,
   };
   ```

3. Add new settings section in `HivemindSettingTab.display()`:
   - Section header: "Frontmatter Commands"
   - Setting: "Default entity type" (dropdown with entity types + '' for "Always ask")
   - Setting: "Auto-merge frontmatter" (toggle) — "Skip preview modal when adding frontmatter"
   - Setting: "Validation severity" (dropdown: error/warning) — "How to treat folder-type mismatches"
   - Setting: "Show validation notices" (toggle) — "Show notice when opening a file with invalid frontmatter"

4. Wire settings to command behavior:
   - In `addFrontmatterToFile()`: if autoMergeFrontmatter is true AND type is exact, skip preview modal and apply directly
   - In `validateCurrentFile()`: use validationSeverity to determine if folder_mismatch is error or warning
   - If showValidationNotices: register 'file-open' event to auto-validate active file

5. Clean up any unused code from old commands (e.g., if checkMissingFrontmatter is fully replaced, remove it). Ensure no dead code remains.
  </action>
  <verify>
Build: `cd obsidian-plugin && npm run build`. No TypeScript errors. Settings tab shows new options. No unused/dead code.
  </verify>
  <done>
Settings tab has Frontmatter Commands section with all toggleable behaviors. Settings control command behavior (auto-merge, validation severity, notices on open). No dead code.
  </done>
</task>

</tasks>

<verification>
1. `cd obsidian-plugin && npm run build` succeeds
2. Sidebar panel opens and shows validation results
3. Clicking file in sidebar navigates to it
4. Settings tab has all new options
5. Folder context menus work for validate and fix
6. No dead code from old commands
</verification>

<success_criteria>
- Sidebar panel shows vault-wide validation with file navigation
- Settings tab has frontmatter behavior toggles
- Folder context menus for validate and fix operations
- Settings wire to command behavior (auto-merge, severity, notices)
- Plugin builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-obsidian-commands/16-03-SUMMARY.md`
</output>
