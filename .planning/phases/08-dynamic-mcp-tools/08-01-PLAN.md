# Plan 08-01: Dynamic MCP Tool Generation

## Goal

Create infrastructure to auto-generate MCP tools from template entity types.

## Requirements Covered

- TOOL-01: Auto-generate query_X tools
- TOOL-02: Auto-generate list_X tools
- TOOL-03: Template-specific descriptions
- TOOL-04: Integration with search_vault filters
- TOOL-05: Type-aware formatted responses

## Tasks

### Task 1: Create Tool Generator Module

**File**: `src/mcp/tool-generator.ts`

Create functions to generate tool definitions and handlers:

```typescript
interface GeneratedTool {
  definition: ToolDefinition;
  handler: (args: any, server: HivemindServer) => Promise<MCPResponse>;
}

// Generate query_<entityType> tool
function generateQueryTool(entityType: EntityTypeConfig): GeneratedTool

// Generate list_<entityType> tool
function generateListTool(entityType: EntityTypeConfig): GeneratedTool

// Generate all tools for a template
function generateToolsForTemplate(template: TemplateRegistryEntry): GeneratedTool[]
```

### Task 2: Create MCP Module Index

**File**: `src/mcp/index.ts`

Export all MCP-related utilities.

### Task 3: Update Server for Dynamic Tools

**File**: `src/server.ts`

1. Import tool generator
2. In `ListToolsRequestSchema` handler:
   - Get active template from registry
   - Generate tools for all entity types
   - Merge with static tools (search_vault, etc.)
3. In `CallToolRequestSchema` handler:
   - Check if tool name matches `query_<type>` or `list_<type>` pattern
   - If match, route to generated handler
   - Otherwise, use existing static handlers

### Task 4: Add Generic Query Handler

**File**: `src/server.ts`

Create `handleGenericQuery(entityType: string, args)` that:
1. Calls `searchEngine.getNodeWithRelationships(args.id)`
2. Filters by entity type
3. Formats response based on entity type schema
4. Returns suggestions if not found

### Task 5: Add Generic List Handler

**File**: `src/server.ts`

Create `handleGenericList(entityType: string, args)` that:
1. Calls `searchEngine.search()` with type filter
2. Formats results list
3. Supports pagination (limit, offset)

### Task 6: Unit Tests

**File**: `tests/mcp/tool-generator.test.ts`

Test:
- Tool generation for each entity type
- Tool definition structure (name, description, inputSchema)
- Handler execution
- Integration with template registry

## Verification

```bash
npm run build
npm test

# Manual: Start server and check tool list
npx hivemind start --vault ./test-vault
# Then in Claude Desktop, verify new tools appear
```

## Success Criteria

- [ ] `generateQueryTool()` creates valid tool definitions
- [ ] `generateListTool()` creates valid tool definitions
- [ ] Server exposes query_X and list_X for all entity types
- [ ] Generated tools execute correctly
- [ ] Existing tests pass
- [ ] Build succeeds
