---
phase: 06-template-infrastructure-core
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "System loads template definitions from config at startup"
  artifacts:
    - path: "src/server.ts"
      provides: "Template system initialization at server startup"
      contains: "initializeTemplates"
  key_links:
    - from: "src/server.ts"
      to: "src/templates/loader.ts"
      via: "imports and calls initializeTemplates"
      pattern: "initializeTemplates\\(\\)"
---

<objective>
Wire template system into server startup.

Purpose: Close the single gap blocking Phase 6 completion. The template infrastructure is fully implemented and tested, but never called at server startup.

Output: Template system initializes automatically when HivemindServer starts.
</objective>

<execution_context>
@C:\Users\Preston\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Preston\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-template-infrastructure-core/06-VERIFICATION.md
@src/server.ts
@src/templates/loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate template initialization into HivemindServer.start()</name>
  <files>src/server.ts</files>
  <action>
    1. Add import at top of file:
       ```typescript
       import { initializeTemplates } from './templates/index.js';
       import type { TemplateConfig } from './templates/index.js';
       ```

    2. Add private field to HivemindServer class (after line 45, with other private fields):
       ```typescript
       private templateConfig?: TemplateConfig;
       ```

    3. In the `start()` method (around line 1652), add template initialization BEFORE the vault scan:
       ```typescript
       async start(): Promise<void> {
         // Initialize template system
         console.error('[Server] Initializing template system...');
         try {
           this.templateConfig = initializeTemplates();
           console.error(`[Server] Template system initialized: ${this.templateConfig.activeTemplate}`);
         } catch (err) {
           console.error('[Server] Warning: Template initialization failed:', err);
           // Continue without templates for backwards compatibility
         }

         // Initial vault scan (existing code)
         console.error('Performing initial vault scan...');
         // ... rest of existing start() method
       ```

    Note: Wrap in try/catch for backwards compatibility - existing vaults without template config should still work.
  </action>
  <verify>
    1. TypeScript compiles: `npx tsc --noEmit`
    2. Grep confirms import: `grep -n "initializeTemplates" src/server.ts`
    3. Grep confirms call in start(): `grep -A5 "async start" src/server.ts | grep initializeTemplates`
  </verify>
  <done>
    - HivemindServer imports initializeTemplates from templates module
    - start() method calls initializeTemplates() before vault scan
    - Active template is logged to stderr at startup
    - Template config stored in this.templateConfig for runtime access
    - Existing functionality unaffected (backwards compatible)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify integration end-to-end</name>
  <files>src/server.ts</files>
  <action>
    1. Build the project: `npm run build`

    2. Run the test suite to ensure no regressions: `npm test`

    3. Manually verify startup log shows template initialization:
       - Start server briefly (will exit due to no vault, that's OK)
       - Look for "[Server] Template system initialized: worldbuilding" in stderr
       - Or run: `node dist/index.js 2>&1 | head -20`

    4. If all passes, the gap is closed.
  </action>
  <verify>
    1. `npm run build` succeeds with no errors
    2. `npm test` shows all 18+ tests passing
    3. Server startup logs show template initialization message
  </verify>
  <done>
    - Build succeeds
    - All tests pass
    - Startup logs confirm template system initializes
    - Phase 6 gap closed: "System loads template definitions from config at startup" now TRUE
  </done>
</task>

</tasks>

<verification>
After completion, verify the gap is closed:

1. Grep confirms wiring:
   ```bash
   grep -n "initializeTemplates" src/server.ts
   # Should show import line and call in start()
   ```

2. Build passes:
   ```bash
   npm run build
   ```

3. Tests pass:
   ```bash
   npm test
   ```

4. Server startup shows template initialization:
   ```bash
   node dist/index.js --vault ./sample-vault 2>&1 | head -30 | grep -i template
   # Should show: [Server] Template system initialized: worldbuilding
   ```
</verification>

<success_criteria>
1. src/server.ts imports initializeTemplates from templates module
2. HivemindServer.start() calls initializeTemplates() before vault operations
3. Template config stored in class field for runtime access
4. Build succeeds, all tests pass
5. Startup logs show template system initialization
6. Phase 6 verification re-run would show 5/5 truths verified
</success_criteria>

<output>
After completion, create `.planning/phases/06-template-infrastructure-core/06-05-SUMMARY.md`
</output>
