---
phase: 07-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/migration/parity.test.ts
  - tests/migration/fixtures/worldbuilding-vault/Characters/alice.md
  - tests/migration/fixtures/worldbuilding-vault/Locations/tavern.md
  - tests/fixtures.ts
autonomous: true

must_haves:
  truths:
    - "Snapshot tests capture v1.0 MCP tool response format"
    - "Test fixtures include representative worldbuilding entities"
    - "Snapshot comparison validates migration parity"
  artifacts:
    - path: "tests/migration/parity.test.ts"
      provides: "Snapshot tests for v1.0 parity validation"
      contains: "toMatchSnapshot"
    - path: "tests/migration/fixtures"
      provides: "Test vault with worldbuilding entities"
  key_links:
    - from: "tests/migration/parity.test.ts"
      to: "vitest snapshot"
      via: "toMatchSnapshot assertion"
      pattern: "expect.*toMatchSnapshot"
---

<objective>
Create snapshot tests for v1.0 parity validation.

Purpose: Capture current MCP tool response formats as snapshots. After migration, compare responses to ensure exact parity. These become permanent regression fixtures.

Output:
- Test vault fixture with representative worldbuilding entities
- Snapshot tests for query_character, query_location, search_vault
- Baseline snapshots that capture v1.0 behavior
</objective>

<execution_context>
@C:\Users\Preston\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Preston\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-migration/07-CONTEXT.md
@.planning/phases/07-migration/07-RESEARCH.md
@src/server.ts
@tests/integration/vault-graph-search.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test Vault Fixtures</name>
  <files>
    tests/migration/fixtures/worldbuilding-vault/Characters/alice.md
    tests/migration/fixtures/worldbuilding-vault/Characters/bob.md
    tests/migration/fixtures/worldbuilding-vault/Locations/tavern.md
    tests/migration/fixtures/worldbuilding-vault/Locations/castle.md
    tests/migration/fixtures/worldbuilding-vault/Events/battle.md
  </files>
  <action>
Create a minimal test vault with representative entities that exercise the v1.0 system.

tests/migration/fixtures/worldbuilding-vault/Characters/alice.md:
```markdown
---
id: alice
type: character
status: canon
title: Alice the Brave
name: Alice
age: 28
gender: female
race: human
appearance:
  height: "5'6\""
  build: athletic
  hair: auburn
  eyes: green
  clothing: leather armor
  distinctive_features: scar on left cheek
personality:
  traits:
    - brave
    - impulsive
    - loyal
  motivation: protect the innocent
tags:
  - warrior
  - protagonist
---

# Alice the Brave

Alice is a renowned warrior who has dedicated her life to protecting the common folk from threats both mundane and magical.

## Background

Born in [[Tavern]] district, Alice grew up in the shadow of [[Castle]] Ironhold. She trained with [[Bob]] before the [[Battle of Ironhold]].

## Notable Deeds

- Defended the village against raiders
- Discovered ancient ruins
- Formed alliance with forest spirits
```

tests/migration/fixtures/worldbuilding-vault/Characters/bob.md:
```markdown
---
id: bob
type: character
status: draft
title: Bob the Wise
name: Bob
age: 65
gender: male
race: human
appearance:
  height: "5'10\""
  build: thin
  hair: grey
  eyes: blue
  clothing: robes
  distinctive_features: long beard
personality:
  traits:
    - wise
    - patient
    - mysterious
  motivation: preserve knowledge
tags:
  - wizard
  - mentor
---

# Bob the Wise

Bob is an elderly wizard who serves as Alice's mentor.

## Background

He was once an advisor to the king at [[Castle]] before retiring to the [[Tavern]] district.
```

tests/migration/fixtures/worldbuilding-vault/Locations/tavern.md:
```markdown
---
id: tavern
type: location
status: canon
title: The Golden Flagon
name: The Golden Flagon
region: Ironhold District
category: establishment
hierarchy_level: building
climate: temperate
inhabitants:
  - alice
tags:
  - social
  - starting-location
---

# The Golden Flagon

A popular tavern in the heart of Ironhold, known for its warm atmosphere and excellent ale.

## Description

The tavern is a two-story wooden building with a distinctive golden flagon sign hanging above the door.

## Notable Features

- Large common room with fireplace
- Private meeting rooms upstairs
- Secret cellar entrance
```

tests/migration/fixtures/worldbuilding-vault/Locations/castle.md:
```markdown
---
id: castle
type: location
status: canon
title: Castle Ironhold
name: Castle Ironhold
region: Ironhold
category: fortification
hierarchy_level: building
climate: temperate
children:
  - throne-room
  - dungeon
tags:
  - government
  - military
---

# Castle Ironhold

The ancient seat of power in the region, Castle Ironhold has stood for over five centuries.

## Description

A massive stone fortress overlooking the city, with high walls and numerous towers.
```

tests/migration/fixtures/worldbuilding-vault/Events/battle.md:
```markdown
---
id: battle-ironhold
type: event
status: canon
title: Battle of Ironhold
name: Battle of Ironhold
date: 1247-06-15
event_type: military
participants:
  - alice
  - bob
locations:
  - castle
outcome: Victory for the defenders
tags:
  - war
  - turning-point
---

# The Battle of Ironhold

A pivotal battle that determined the fate of the kingdom.

## Summary

The forces of darkness laid siege to [[Castle]] Ironhold. [[Alice]] led the defense while [[Bob]] provided magical support.

## Aftermath

The victory secured peace for a generation but came at great cost.
```
  </action>
  <verify>
Files exist in tests/migration/fixtures/worldbuilding-vault/ with proper YAML frontmatter.
  </verify>
  <done>
Test vault fixtures created with characters, locations, and events that have wikilinks between them.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Parity Snapshot Tests</name>
  <files>
    tests/migration/parity.test.ts
    tests/fixtures.ts
  </files>
  <action>
Create snapshot tests that capture v1.0 MCP tool responses.

tests/migration/parity.test.ts:
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { HivemindServer } from '../../src/server.js';
import { join } from 'path';
import { mkdirSync, rmSync, existsSync } from 'fs';

/**
 * Migration Parity Tests
 *
 * These tests capture the v1.0 MCP tool response format as snapshots.
 * After migration to template system, these snapshots ensure exact parity.
 *
 * To update snapshots after intentional changes:
 *   npm test -- tests/migration/parity.test.ts --update
 */
describe('Migration Parity: v1.0 MCP Tool Responses', () => {
  let server: HivemindServer;
  const testVaultPath = join(__dirname, 'fixtures', 'worldbuilding-vault');
  const tempDbPath = join(__dirname, 'fixtures', '.hivemind-test');

  beforeAll(async () => {
    // Clean up any previous test database
    if (existsSync(tempDbPath)) {
      rmSync(tempDbPath, { recursive: true });
    }
    mkdirSync(tempDbPath, { recursive: true });

    server = new HivemindServer({
      vault: {
        path: testVaultPath,
        watchForChanges: false,
      },
      server: {
        transport: 'stdio',
      },
    });

    // Initialize without starting transport (we'll call handlers directly)
    // @ts-expect-error - accessing private method for testing
    await server.ensureIndexed();
  });

  afterAll(() => {
    // @ts-expect-error - accessing private property
    server.database?.close();

    // Clean up test database
    if (existsSync(tempDbPath)) {
      rmSync(tempDbPath, { recursive: true });
    }
  });

  describe('query_character', () => {
    it('returns expected format for existing character', async () => {
      const response = await callTool(server, 'query_character', {
        id: 'alice',
        includeContent: true,
        contentLimit: 500,
      });

      // Normalize timestamps for snapshot consistency
      const normalized = normalizeResponse(response);
      expect(normalized).toMatchSnapshot();
    });

    it('returns suggestions for non-existent character', async () => {
      const response = await callTool(server, 'query_character', {
        id: 'nonexistent',
      });

      expect(response.content[0].text).toMatchSnapshot();
    });

    it('respects includeContent=false', async () => {
      const response = await callTool(server, 'query_character', {
        id: 'alice',
        includeContent: false,
      });

      const normalized = normalizeResponse(response);
      expect(normalized).toMatchSnapshot();
    });
  });

  describe('query_location', () => {
    it('returns expected format for existing location', async () => {
      const response = await callTool(server, 'query_location', {
        id: 'tavern',
        includeContent: true,
        contentLimit: 500,
      });

      const normalized = normalizeResponse(response);
      expect(normalized).toMatchSnapshot();
    });

    it('returns suggestions for non-existent location', async () => {
      const response = await callTool(server, 'query_location', {
        id: 'nonexistent',
      });

      expect(response.content[0].text).toMatchSnapshot();
    });
  });

  describe('search_vault', () => {
    it('returns results for keyword search', async () => {
      const response = await callTool(server, 'search_vault', {
        query: 'brave warrior',
        limit: 5,
      });

      const normalized = normalizeSearchResponse(response);
      expect(normalized).toMatchSnapshot();
    });

    it('filters by entity type', async () => {
      const response = await callTool(server, 'search_vault', {
        query: 'alice',
        filters: { type: ['character'] },
        limit: 5,
      });

      const normalized = normalizeSearchResponse(response);
      expect(normalized).toMatchSnapshot();
    });

    it('filters by status', async () => {
      const response = await callTool(server, 'search_vault', {
        query: 'bob',
        filters: { status: ['draft'] },
        limit: 5,
      });

      const normalized = normalizeSearchResponse(response);
      expect(normalized).toMatchSnapshot();
    });
  });

  describe('get_canon_status', () => {
    it('returns entities grouped by status', async () => {
      const response = await callTool(server, 'get_canon_status', {});

      const normalized = normalizeResponse(response);
      expect(normalized).toMatchSnapshot();
    });

    it('filters by specific status', async () => {
      const response = await callTool(server, 'get_canon_status', {
        status: 'canon',
      });

      const normalized = normalizeResponse(response);
      expect(normalized).toMatchSnapshot();
    });
  });

  describe('validate_consistency', () => {
    it('checks full vault for issues', async () => {
      const response = await callTool(server, 'validate_consistency', {});

      const normalized = normalizeResponse(response);
      expect(normalized).toMatchSnapshot();
    });
  });
});

/**
 * Helper to call MCP tool handler directly
 */
async function callTool(server: HivemindServer, name: string, args: Record<string, any>) {
  // @ts-expect-error - accessing private handlers for testing
  const handler = server.server._requestHandlers.get('tools/call');

  const request = {
    params: { name, arguments: args },
  };

  // Find the right handler method
  switch (name) {
    case 'query_character':
      // @ts-expect-error - private method
      return server.handleQueryCharacter(args);
    case 'query_location':
      // @ts-expect-error - private method
      return server.handleQueryLocation(args);
    case 'search_vault':
      // @ts-expect-error - private method
      return server.handleSearchVault(args);
    case 'get_canon_status':
      // @ts-expect-error - private method
      return server.handleGetCanonStatus(args);
    case 'validate_consistency':
      // @ts-expect-error - private method
      return server.handleValidateConsistency(args);
    default:
      throw new Error(`Unknown tool: ${name}`);
  }
}

/**
 * Normalize response for snapshot consistency
 * - Removes timestamps that change between runs
 * - Normalizes file paths
 */
function normalizeResponse(response: any): any {
  const text = response.content?.[0]?.text || '';

  // Replace timestamps with placeholder
  const normalized = text
    .replace(/\*Last updated: .*\*/g, '*Last updated: [TIMESTAMP]*')
    .replace(/Updated: .*\n/g, 'Updated: [TIMESTAMP]\n')
    // Normalize file paths (Windows vs Unix)
    .replace(/\\/g, '/')
    // Remove absolute path prefixes
    .replace(/[A-Z]:\//gi, '/')
    .replace(/\/[^/]+\/[^/]+\/tests\/migration\/fixtures\//g, '/fixtures/');

  return {
    ...response,
    content: [{ type: 'text', text: normalized }],
  };
}

/**
 * Normalize search response
 * - Removes execution times
 * - Removes timestamps
 * - Normalizes paths
 */
function normalizeSearchResponse(response: any): any {
  const text = response.content?.[0]?.text || '';

  const normalized = text
    // Remove execution time which varies
    .replace(/in \d+ms/g, 'in [TIME]ms')
    // Same as normalizeResponse
    .replace(/\*Last updated: .*\*/g, '*Last updated: [TIMESTAMP]*')
    .replace(/\\/g, '/')
    .replace(/[A-Z]:\//gi, '/')
    .replace(/\/[^/]+\/[^/]+\/tests\/migration\/fixtures\//g, '/fixtures/');

  return {
    ...response,
    content: [{ type: 'text', text: normalized }],
  };
}
```

Note: If the direct handler call approach doesn't work due to private method access, create a simpler approach using the public server API or expose test helpers.
  </action>
  <verify>
Run `npm test tests/migration/parity.test.ts` - tests pass and create snapshots in __snapshots__ directory.
  </verify>
  <done>
Snapshot tests capture v1.0 response formats. Baselines created for migration comparison.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run Tests and Commit Snapshots</name>
  <files>
    tests/migration/__snapshots__/parity.test.ts.snap
  </files>
  <action>
1. Run the snapshot tests to generate baseline snapshots:
```bash
npm test tests/migration/parity.test.ts
```

2. Verify snapshots were created in tests/migration/__snapshots__/

3. Review snapshots to ensure they capture expected v1.0 behavior:
- query_character shows character formatting with relationships
- query_location shows location formatting
- search_vault shows result list format
- get_canon_status shows status groupings
- validate_consistency shows issue format

4. If any tests fail due to fixture issues, fix the fixtures and re-run.

5. Snapshots become the "truth" for v1.0 parity. After migration, running these tests validates that responses haven't changed.
  </action>
  <verify>
Snapshots exist in tests/migration/__snapshots__/.
Run `npm test tests/migration/parity.test.ts` twice - second run passes (no changes).
  </verify>
  <done>
Baseline snapshots committed. Future runs will detect any response format changes.
  </done>
</task>

</tasks>

<verification>
1. Test vault fixtures exist with valid frontmatter
2. Snapshot tests pass and generate baselines
3. Running tests twice shows no changes (stable)
4. Snapshots capture response format, not variable data
</verification>

<success_criteria>
- [ ] Test vault has 5 entities (2 characters, 2 locations, 1 event)
- [ ] Entities have wikilinks between them for relationship testing
- [ ] parity.test.ts uses vitest toMatchSnapshot()
- [ ] Timestamps and execution times normalized in snapshots
- [ ] File paths normalized (cross-platform)
- [ ] Baseline snapshots created in __snapshots__ directory
- [ ] All snapshot tests pass on repeated runs
</success_criteria>

<output>
After completion, create `.planning/phases/07-migration/07-03-SUMMARY.md`
</output>
